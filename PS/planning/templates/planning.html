{% extends 'base.html' %}

{% block title %}Planning{% endblock %}
{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'planning/css/planning.css' %}">
<style>
.fc-daygrid-day-number, .fc-toolbar-title, .fc-col-header-cell-cushion {
    color: white !important;
}
.fc-daygrid-day.fc-day-today {
    background-color: #007bff !important;
}
</style>
{% endblock %}

{% block scripts %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.15/index.global.min.js'></script>
<script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
<script>

    document.addEventListener('DOMContentLoaded', function() {
        try {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                contentHeight: 'auto',
                dateClick: function(info) {
                    document.getElementById('eventDate').value = info.dateStr;
                    document.getElementById('reason').focus();
                },
                events: "{% url 'events_json' %}",
                eventDidMount: function(info) {
                    info.el.style.backgroundColor = info.event.backgroundColor;
                }
            });
            calendar.render();
        }
        catch {
            console.log('No calendar element found');
        }
        var halfDayCheckbox = document.getElementById('is_half_day');
        var endDateField = document.getElementById('end_date').parentElement;
        var halfDayField = document.getElementById('half_day').parentElement;
        halfDayCheckbox.addEventListener('change', function() {
            if (this.checked) {
                endDateField.style.display = 'none';
                halfDayField.style.display = 'block';
            } else {
                endDateField.style.display = 'block';
                halfDayField.style.display = 'none';
            }
        });
        if (halfDayCheckbox.checked) {
            endDateField.style.display = 'none';
            halfDayField.style.display = 'block';
        } else {
            endDateField.style.display = 'block';
            halfDayField.style.display = 'none';
        }
        var startDateField = document.getElementById('start_date');
        var endDateFieldInput = document.getElementById('end_date');
        startDateField.addEventListener('change', function() {
            endDateFieldInput.value = this.value;
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="row">
    {% if request.user.is_staff %}
    <div class="col-sm-8">
        <div class="alert alert-secondary" style="background-color: transparent; color: white; margin-top: 30px">
            <h3 style="text-align: center; margin-top: 30px; margin-bottom: 30px">Create or edit events</h3>
            <hr>
            On this page, you can create or edit events for interns. You can also cancel events that have been previously approved.<br>
            If you want an overview of the events, you can check the calendar on the dashboard page or <a href="{% url 'dashboard' %}#calendar">click here</a>.
        </div>
    </div>
    {% else %}
    <div class="col-sm-8">
        <div id='calendar'></div>
    </div>
    {% endif %}
    <div class="col-sm-4">
        <div id="eventFormSection">
            <h3>Demande de congé</h3>
            <form method="post">
            {% csrf_token %}
                <input type="hidden" id="eventDate" name="start_date">

                {% if request.user.is_staff %}
                <label for="intern" class="form-label">Interne:</label><br>
                <select class="form-select" id="intern_id" name="intern_id" required>
                    <option value="" disabled selected>Selectionner un interne:</option>
                    {% for intern in intern_list %}
                    <option value="{{ intern.id }}">{{ intern.user.get_full_name }}</option>
                    {% endfor %}
                </select><br>
                {% else %}
                <input type="hidden" value="{{ request.user.id }}" id="intern_id" name="intern_id">
                {% endif %}

                <label for="reason" class="form-label">Motif:</label><br>
                <select class="form-select" id="reason" name="reason" required>
                    <option value="" disabled selected>Selectionner une option</option>
                    {% for reason in reasons %}
                    <option value="{{ reason }}">{{ reason }}</option>
                    {% endfor %}
                </select><br>

                <p>Pour une demi-journée</p>
                <input type="checkbox" id="is_half_day" name="is_half_day" value="1"><br>

                <label for="start_date" class="form-label">Date de départ:</label>
                <input type="date" class="form-control" id="start_date" name="start_date" required>

                <div>
                    <label for="end_date" class="form-label">Date de fin:</label>
                    <input type="date" class="form-control" id="end_date" name="end_date" required><br>
                </div>

                <div>
                    <label for="half_day" class="form-label">A quel moment de la journée ?</label>
                    <select class="form-select" id="half_day" name="half_day" required>
                        <option value="1" selected>Dans la matinée</option>
                        <option value="2">Dans l'après-midi</option>
                    </select>
                </div>

                <button class="btn btn-outline-secondary" type="submit">Soumettre la demande</button>
            </form>
            <h3>Infos:</h3>
            <p>Jours de congé restants: {{ daysoff_left }}</p>
            <p>Jours de congé en attente: {{ daysoff_onhold }}</p>
        </div>
    </div>
</div>
<div class="row">
    <div class="alert alert-secondary" style="background-color: transparent; color: white; margin-top: 30px">
        <h3 style="text-align: center; margin-top: 30px; margin-bottom: 30px">Event list</h3>
        <hr>
        <table class="table">
            <thead>
                <tr>
                    {% if request.user.is_staff %}
                    <th colspan="6">Nom</th>
                    {% endif %}
                    <th>Date de la demande</th>
                    <th>Date de départ</th>
                    <th>Date de fin</th>
                    <th>Motif</th>
                    <th>Durée</th>
                    <th>Commentaire RH</th>
                    <th>Réponse</th>
                    {% if request.user.is_staff %}
                    <th>Annuler</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for event in event_list %}
                <tr>
                    {% if request.user.is_staff %}
                    <td colspan="6">{{ event.intern.user.get_full_name }}</td>
                    {% endif %}
                    <td>{{ event.request_date }}</td>
                    <td>{{ event.start_date }}</td>
                    <td>{{ event.end_date }}</td>
                    <td>{{ event.reason }}</td>
                    <td>{{ event.duration }}</td>
                    <td>{{ event.comment }}</td>
                    {% if event.approbation == 0 %}
                    <td>En attente</td>
                    {% elif event.approbation == 1 %}
                    <td>Approuvé</td>
                    {% elif event.approbation == 2 %}
                    <td>Refusé</td>
                    {% elif event.approbation == 3 %}
                    <td>Annulé</td>
                    {% endif %}
                    {% if request.user.is_staff %}
                    {% if event.approbation == 1 %}
                    <td style="text-align: right">
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="event_id" id="event_id" value="{{ event.id }}">
                            <a href="javascript:;" onclick="parentNode.submit()" style="padding: 0; margin:0">X</a>
                        </form>
                    </td>
                    {% endif %}
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}