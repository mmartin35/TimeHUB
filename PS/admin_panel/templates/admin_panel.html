{% extends 'base.html' %}

{% block title %}Admin Panel: Dashboard{% endblock %}
{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'admin_panel/css/admin_panel.css' %}">
<style>
.fc-daygrid-day-number, .fc-toolbar-title, .fc-col-header-cell-cushion {
    color: white !important;
}
.fc-daygrid-day.fc-day-today {
    background-color: #007bff !important;
}
</style>
{% endblock %}

{% block scripts %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.15/index.global.min.js'></script>
<script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            contentHeight: 'auto',
            dateClick: function(info) {
                document.getElementById('eventDate').value = info.dateStr;
                document.getElementById('reason').focus();
            },
            events: "{% url 'admin_events_json' %}",
            eventDidMount: function(info) {
                info.el.style.backgroundColor = info.event.backgroundColor;
            }
        });
        calendar.render();
        var carousels = document.querySelectorAll('.carousel');
        carousels.forEach(function(carousel) {
            var carouselInstance = new bootstrap.Carousel(carousel, {
                wrap: false,
                interval: false
            });
            var items = carousel.querySelectorAll('.carousel-item');
            if (items.length > 0) {
                items[items.length - 1].classList.add('active');
                items[0].classList.remove('active');
            }
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="row">
    {% for alert in alerts %}
    <div class="alert alert-danger" role="alert" style="width: 100%">
    {{ alert }}
    </div>
    {% endfor %}
</div>
<div class="row">
    <div class="col-4">
        {% for intern in interns_list %}
        <p>
            <div class="row">
                <div class="col">
                    <form method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="user_id" value="{{ intern.id }}">
                        <button type="submit" name="user_id" value="{{ intern.id }}" class="btn {% if intern.is_active %}btn-success{% else %}btn-danger{% endif %}" style="width: 100%">
                            {% if intern.id == requested_user %}
                            <b>{{ intern.user.get_full_name }}</b>
                            {% else %}
                            {{ intern.user.get_full_name }}
                            {% endif %}
                        </button>
                    </form>
                </div>
                <div class="col">
                    <a class="btn btn-link" data-bs-toggle="collapse" href="#collapse{{ intern.user.username }}_infos" role="button" aria-expanded="false" aria-controls="collapse{{ intern.user.username }}">Details</a>
                </div>
            </div>
        </p>
        <div class="collapse" id="collapse{{ intern.user.username }}_infos">
            <div class="card card-body">
                <p><strong>Full name:</strong> {{ intern.user.get_full_name }}<br>
                <strong>Email:</strong> {{ intern.user.email }}<br>
                <strong>Arrival:</strong> {{ intern.arrival }}<br>
                <strong>Departure:</strong> {{ intern.departure }}<br>
                <strong>Total hours:</strong> {{ intern.total_hours|floatformat:2 }}/{{ intern.mandatory_hours }}h<br>
                <strong>Days off:</strong> {{ intern.days_off_left }}/{{ intern.days_off_total }}</p>
                <a href="{% url 'report' intern.user.username requested_month %}" target="_blank">Print report</a>
            </div>
        </div>
        {% endfor %}
        <a class="btn btn-dark" href="{% url 'global_report' requested_month %}" target="_blank" style="width: 100%">Get report of every interns</a>
    </div>
    <div class="col-8">
        <div id="carousel{{ intern.user.username }}" class="carousel slide" data-interval="false">
            <div class="carousel-inner">
                {% for week, days in intern_weeks_data.items %}
                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                    <table class="table table" style="color: white">
                        <thead>
                            <tr>
                                <th>Week {{ week }}</th>
                                <th>T1:</th>
                                <th>T2:</th>
                                <th>T3:</th>
                                <th>T4:</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day in days %}
                            <tr>
                                <td>{{ day.date }}</td>
                                <td>{{ day.t1 }}</td>
                                <td>{{ day.t2 }}</td>
                                <td>{{ day.t3 }}</td>
                                <td>{{ day.t4 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endfor %}
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carousel{{ intern.user.username }}" data-bs-slide="prev" style="opacity:10%; height:100%; width: 1.5%">
                <!-- Control content -->
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carousel{{ intern.user.username }}" data-bs-slide="next" style="opacity:10%; height:100%; width: 1.5%">
                <!-- Control content -->
            </button>
        </div>
    </div>
</div>

<hr>
<div class="row">
    <div id="calendar"></div>
</div>

<div class="row">
    {% for intern in interns_list %}
    <div class="col">
        {% for event in intern.event_set.all %}
        {% if not event.is_archived %}
        <div class="card" style="margin: 15px">
            <div class="card-header">
                <h4>Requested on {{ event.request_date }}</h4>
            </div>
            <div class="card-body">
                <p><strong>Intern: </strong>{{ event.intern.user.get_full_name }}<br>
                <strong>Reason: </strong>{{ event.reason }}<br>
                <strong>From: </strong>{{ event.start_date }}<br>
                <strong>To: </strong>{{ event.end_date }}<br>
                <strong>Duration: </strong>{{ event.duration }} day(s)</p>
                <form method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="event_id" value="{{ event.id }}">
                    <textarea name="staff_comment" placeholder="Add a comment" required></textarea>
                    <div class="action-buttons">
                        <button type="submit" name="approve_event" value="true" class="btn btn-success">Approve</button>
                        <button type="submit" name="reject_event" value="true" class="btn btn-danger">Reject</button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
    {% endfor %}
</div>
{% endblock %}
