{% extends 'base.html' %}

{% block title %}Admin Panel: Dashboard{% endblock %}
{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'admin_panel/css/admin_panel.css' %}">
<style>
.fc-daygrid-day-number, .fc-toolbar-title, .fc-col-header-cell-cushion {
    color: white !important;
}
.fc-daygrid-day.fc-day-today {
    background-color: #007bff !important;
}
</style>
{% endblock %}

{% block scripts %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.15/index.global.min.js'></script>
<script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            contentHeight: 'auto',
            dateClick: function(info) {
                document.getElementById('eventDate').value = info.dateStr;
                document.getElementById('reason').focus();
            },
            events: "{% url 'admin_events_json' %}",
            eventDidMount: function(info) {
                info.el.style.backgroundColor = info.event.backgroundColor;
            }
        });
        calendar.render();
    });
</script>
{% endblock %}

{% block content %}
<div class="d-flex flex-column" style="margin-top: 20px">
    <div class="p-2">
        {% for intern in interns_with_timers %}
        {% if intern.is_ongoing %}
        <p>
        <a class="btn {% if intern.is_active %}btn-success{% else %}btn-danger{% endif %}" data-bs-toggle="collapse" href="#collapse{{ intern.user.username }}" role="button" aria-expanded="false" aria-controls="collapse{{ intern.user.username }}">
            {{ intern.user.get_full_name }}</a>
        <a class="btn btn-link" data-bs-toggle="collapse" href="#collapse{{ intern.user.username }}_infos" role="button" aria-expanded="false" aria-controls="collapse{{ intern.user.username }}">Details</a>
        </p>

        <div class="collapse" id="collapse{{ intern.user.username }}_infos">
            <div class="card card-body">
                <p><strong>Full name:</strong> {{ intern.user.get_full_name }}<br>
                <strong>Email:</strong> {{ intern.user.email }}<br>
                <strong>Arrival:</strong> {{ intern.arrival }}<br>
                <strong>Departure:</strong> {{ intern.departure }}<br>
                <strong>Total hours:</strong> {{ intern.total_hours|floatformat:2 }}/{{ intern.mandatory_hours }}h<br>
                <strong>Days off:</strong> {{ intern.days_off_left }}/{{ intern.days_off_total }}</p>
            </div>
        </div>
        <div class="collapse" id="collapse{{ intern.user.username }}">
            <div class="card card-body">
                <div id="carousel{{ intern.user.username }}" class="carousel slide" data-interval="false">
                    <div class="carousel-inner">
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                            <p><strong>{{ timer.date }}</strong><br>
                            <strong>T1 at: </strong>{{ timer.t1 }}<br>
                            <strong>T2 at: </strong>{{ timer.t2 }}<br>
                            <strong>T3 at: </strong>{{ timer.t3 }}<br>
                            <strong>T4 at: </strong>{{ timer.t4 }}<br>
                            <strong>Working Time: </strong>{{ timer.working_hours|floatformat:2 }}h</p>
                        </div>
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carousel{{ intern.user.username }}" data-bs-slide="prev" style="opacity: 0">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carousel{{ intern.user.username }}" data-bs-slide="next" style="opacity: 0">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden"></span>
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
    <div class="col">
        <div id="calendar"></div>
    </div>
</div>
<div class="row">
    {% for intern in interns_with_timers %}
    {% if intern.is_ongoing %}
    <div class="col">
        {% for event in intern.event_set.all %}
        {% if not event.is_archived %}
        <div class="card" style="margin: 15px">
            <div class="card-header">
                <h4>Requested on {{ event.request_date }}</h4>
            </div>
            <div class="card-body">
                <p><strong>Intern: </strong>{{ event.intern.user.get_full_name }}<br>
                <strong>Reason: </strong>{{ event.reason }}<br>
                <strong>From: </strong>{{ event.start_date }}<br>
                <strong>To: </strong>{{ event.end_date }}<br>
                <strong>Duration: </strong>{{ event.duration }} day(s)</p>
                <form method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="event_id" value="{{ event.id }}">
                    <textarea name="staff_comment" placeholder="Add a comment" required></textarea>
                    <div class="action-buttons">
                        <button type="submit" name="approve_event" value="true" class="btn btn-success">Approve</button>
                        <button type="submit" name="reject_event" value="true" class="btn btn-danger">Reject</button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
    {% endif %}
    {% endfor %}
</div>
<div class="row">
    {% for service_timer in service_timers %}
    <div class="alert alert-danger" role="alert" style="width: 30%">
    {{ service_timer.intern.user.first_name }}: Depuis  {{ service_timer.t1_service|date:"H:i"}}
    </div>
    {% endfor %}
</div>
{% endblock %}
